<div class="dashboard-container" [class.menu-collapsed]="!isMenuOpen" [class.menu-open]="isMenuOpen && isMobile">
  <!-- Banned user banner -->
  <div class="banned-banner" *ngIf="bannedUserService.isBanned()">
    <mat-icon>warning</mat-icon>
    <span>Votre compte est actuellement suspendu. Contactez l'administrateur via la messagerie pour plus d'informations.</span>
  </div>

  <!-- Sidebar -->
  <nav class="side-nav" [class.collapsed]="!isMenuOpen" [class.sidebar-locked]="!isVerified && verificationStatusChecked">
    <div class="logo-section">
      <div class="logo">
        <div class="logo-img-container">
          <img src="assets/images/molarisse.png" alt="Tooth Logo" class="tooth-logo">
          <div class="shine-effect"></div>
        </div>
        <span class="logo-text"></span>
        <span class="role-text">Médecin</span>
      </div>
    </div>

    <div class="nav-links">
      <a class="nav-link" (click)="showDashboard()" 
         [class.active]="activeSection === 'dashboard'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('dashboard')"
         [attr.tabindex]="0">
        <div class="nav-icon">
          <i class="fas fa-home"></i>
        </div>
        <span>Tableau de bord</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('dashboard')" class="locked-icon">lock</mat-icon>
      </a>
      
      <a class="nav-link" (click)="showProfile()" 
         [class.active]="activeSection === 'profile'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('profile')"
         [attr.tabindex]="0">
        <div class="nav-icon">
          <i class="fas fa-user"></i>
        </div>
        <span>Mon Profil</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('profile')" class="locked-icon">lock</mat-icon>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'appointments', showAppointments)" 
         [class.active]="activeSection === 'appointments'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('appointments')"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-calendar-check"></i>
        </div>
        <span>Mes RDV</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('appointments')" class="locked-icon">lock</mat-icon>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'calendar', showCalendar)" 
         [class.active]="activeSection === 'calendar'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('calendar')"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <span>Calendrier</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('calendar')" class="locked-icon">lock</mat-icon>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'patients', showPatients)" 
         [class.active]="activeSection === 'patients'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('patients')"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-user-injured"></i>
        </div>
        <span>Mes Patients</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('patients')" class="locked-icon">lock</mat-icon>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'statistics', showStatistics)" 
         [class.active]="activeSection === 'statistics'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked) || bannedUserService.shouldDisableLink('statistics')"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-chart-bar"></i>
        </div>
        <span>Statistiques</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('statistics')" class="locked-icon">lock</mat-icon>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'messaging', showMessaging)" 
         [class.active]="activeSection === 'messaging'" 
         [class.disabled-nav-link]="!isVerified && verificationStatusChecked"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-comments"></i>
        </div>
        <span>Messagerie</span>
      </a>

      <a class="nav-link" (click)="onNavClick($event, 'unassigned-secretaries', showUnassignedSecretaries)"
         [class.active]="activeSection === 'unassigned-secretaries'" 
         [class.disabled-nav-link]="(!isVerified && verificationStatusChecked)" 
         matTooltip="Secrétaires disponibles"
         [attr.tabindex]="(!isVerified && verificationStatusChecked) ? -1 : 0">
        <div class="nav-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <span>Secrétaires disponibles</span>
        <mat-icon *ngIf="bannedUserService.shouldDisableLink('unassigned-secretaries')" class="locked-icon">lock</mat-icon>
      </a>

     

      <!-- Banned account notification if user is banned -->
      <div *ngIf="bannedUserService.isBanned()" class="banned-notification">
        <mat-icon class="warning-icon">warning</mat-icon>
        <span>Compte suspendu</span>
      </div>
    </div>

    <div *ngIf="!isVerified && verificationStatusChecked" class="sidebar-lock-overlay">
      <mat-icon class="sidebar-lock-icon" color="warn">lock</mat-icon>
      <span class="sidebar-lock-text">Accès restreint</span>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Header -->
    <div class="dashboard-header">
      <div class="header-left">
        <button class="menu-toggle" (click)="toggleMenu()" [class.active]="!isMenuOpen" *ngIf="!isMobile">
          <mat-icon>{{ isMenuOpen ? 'menu_open' : 'menu' }}</mat-icon>
        </button>
        <div class="brand">
          <img src="assets/images/molarisse.png" alt="Molarisse" class="brand-logo">
          <span class="brand-name">Molaris</span>
        </div>
        <div class="search-bar">
          <mat-icon class="search-icon">search</mat-icon>
          <input type="text" placeholder="Rechercher..." class="search-input">
        </div>
      </div>
      <div class="header-right">
        <button class="fullscreen-toggle" (click)="toggleFullscreen()" matTooltip="{{ isFullscreen ? 'Quitter le mode plein écran' : 'Mode plein écran' }}">
          <mat-icon>{{ isFullscreen ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
        </button>
        <div class="notifications"
          [class.navbar-icon-locked]="!isVerified && verificationStatusChecked"
          [matTooltip]="isVerified ? 'Notifications' : 'Accès restreint'"
          (click)="isVerified ? null : $event.preventDefault()">
          <app-notification-bell></app-notification-bell>
          <mat-icon *ngIf="!isVerified && verificationStatusChecked" color="warn" style="margin-left: 4px;">lock</mat-icon>
        </div>
        <div class="messaging"
          [class.navbar-icon-locked]="!isVerified && verificationStatusChecked"
          [matTooltip]="isVerified ? 'Messagerie' : 'Accès restreint'"
          (click)="isVerified ? null : $event.preventDefault()">
          <app-message-bell></app-message-bell>
          <mat-icon *ngIf="!isVerified && verificationStatusChecked" color="warn" style="margin-left: 4px;">lock</mat-icon>
        </div>
        <div
          class="staff-button"
          [class.staff-button-locked]="!isVerified && verificationStatusChecked"
          (click)="showMyStaff()"
          [matTooltip]="isVerified ? 'Mon équipe' : 'Accès restreint'"
        >
          <mat-icon>people</mat-icon>
          <mat-icon *ngIf="!isVerified && verificationStatusChecked" color="warn" style="margin-left: 4px;">lock</mat-icon>
        </div>
        <div class="user-profile" (click)="toggleProfileDropdown()">
          <img [src]="profileImage" 
               alt="Profile" 
               class="profile-image" 
               (error)="handleImageError($event)">
          <div class="user-info">
            <span class="user-name">{{ doctorName }}</span>
            <span class="user-role">Médecin</span>
          </div>
          <mat-icon class="dropdown-icon" [class.open]="isProfileDropdownOpen">expand_more</mat-icon>
          <div class="profile-dropdown" [class.show]="isProfileDropdownOpen">
            <a (click)="showProfile()" class="dropdown-item">
              <mat-icon>person</mat-icon>
              <span>Mon Profil</span>
            </a>
           
            <a (click)="logout()" class="dropdown-item logout">
              <mat-icon>logout</mat-icon>
              <span>Déconnexion</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="content-wrapper" [class.menu-collapsed]="!isMenuOpen">
      <!-- Banned user message for dashboard view -->
      <div *ngIf="bannedUserService.isBanned() && activeSection === 'dashboard'">
        <div style="margin: 2rem auto; max-width: 600px; text-align: center; background: #ffebee; border: 1px solid #ffcdd2; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <mat-icon style="font-size: 48px; color: #f44336;">block</mat-icon>
          <h2>Votre compte est actuellement suspendu</h2>
          <p>Vous avez uniquement accès à la messagerie. Veuillez contacter l'administrateur pour plus d'informations.</p>
          <button mat-raised-button color="primary" (click)="showMessaging()">
            <mat-icon>message</mat-icon> Accéder à la messagerie
          </button>
        </div>
      </div>

      <!-- Dashboard View -->
      <div *ngIf="activeSection === 'dashboard' && !bannedUserService.isBanned()">
        <!-- Pending verification message -->
        <div *ngIf="!isVerified && verificationStatusChecked" class="pending-verification-message">
          <mat-card style="margin: 2rem auto; max-width: 600px; text-align: center; background: #fffbe6; border: 1px solid #ffe082;">
            <mat-icon style="font-size: 48px; color: #ffb300;">hourglass_empty</mat-icon>
            <h2>Votre profil est en cours de vérification</h2>
            <p>Vous aurez accès à toutes les fonctionnalités de l'application une fois votre demande acceptée.</p>
          </mat-card>
        </div>
        
        <!-- Verified doctor dashboard content -->
        <ng-container *ngIf="isVerified && verificationStatusChecked">
          <mat-card style="margin: 2rem auto; max-width: 600px; text-align: center; border: 1px solid #e0e0e0;">
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
              <mat-icon style="font-size: 36px; margin-right: 1rem; color: #4caf50;">verified_user</mat-icon>
              <h2 style="margin: 0; color: #333;">État de vérification: <span style="color: #4caf50; font-weight: bold;">Approuvé</span></h2>
            </div>
            <p>Votre compte est vérifié. Vous avez accès à toutes les fonctionnalités de l'application.</p>
          </mat-card>
          
          <div class="welcome-card">
            <div class="welcome-content">
              <h2>Bienvenue dans votre espace médecin</h2>
              <p>Gérez vos rendez-vous et votre cabinet médical.</p>
              <div style="display: flex; gap: 1rem;">
                <button class="welcome-action-btn" (click)="showAppointments()">
                  <i class="fas fa-calendar-plus"></i>
                  Gérer mes rendez-vous
                </button>
                <button class="welcome-action-btn" style="background: #4e5eeb; color: #fff;" (click)="openBookAppointmentDialog()">
                  <mat-icon style="vertical-align: middle;">add</mat-icon>
                  Nouveau rendez-vous
                </button>
              </div>
            </div>
            <div class="welcome-illustration">
              <div class="default-illustration">
                <i class="fas fa-plus-circle illustration-icon"></i>
              </div>
            </div>
          </div>
          
          <div class="stats-container">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="stat-details">
                <h3>Rendez-vous aujourd'hui</h3>
                <p class="stat-number">{{ todayAppointments }}</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="stat-details">
                <h3>En attente de confirmation</h3>
                <p class="stat-number">{{ pendingAppointments }}</p>
              </div>
            </div>
  
            <div class="stat-card">
              <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="stat-details">
                <h3>Total des rendez-vous</h3>
                <p class="stat-number">{{ totalAppointments }}</p>
              </div>
            </div>
          </div>
  
          <!-- Dashboard Main Content - Two Column Layout -->
          <div class="dashboard-main-content">
            <!-- Left Column: Appointments -->
            <div class="dashboard-column">
              <div class="dashboard-card">
                <div class="dashboard-card-header">
                  <h2>Gestion des Rendez-vous</h2>
                  <button mat-button color="primary" (click)="showAppointments()">
                    Voir tout <i class="fas fa-arrow-right"></i>
                  </button>
                </div>
                <div class="dashboard-card-content">
                  <app-doctor-secretary-view></app-doctor-secretary-view>
                </div>
              </div>
            </div>
            
            <!-- Right Column: Statistics -->
            <div class="dashboard-column">
              <div class="dashboard-card">
                <div class="dashboard-card-header">
                  <h2>Statistiques</h2>
                  <button mat-button color="primary" (click)="showStatistics()">
                    Détails <i class="fas fa-arrow-right"></i>
                  </button>
                </div>
                <div class="dashboard-card-content">
                  <app-doctor-statistics [previewMode]="true"></app-doctor-statistics>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Patients List View -->
      <div *ngIf="activeSection === 'patients' && !bannedUserService.isBanned()">
        <div class="section-header">
          <h2>Mes Patients</h2>
          <p>Liste des patients ayant eu des rendez-vous avec vous</p>
        </div>

        <div class="patients-container">
          <div class="search-bar-container">
            <div class="search-input-wrapper">
              <mat-icon>search</mat-icon>
              <input type="text" placeholder="Rechercher un patient..." #searchInput (keyup)="filterPatients(searchInput.value)">
            </div>
          </div>

          <div class="loading-container" *ngIf="loadingPatients">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Chargement des patients...</p>
          </div>

          <div class="empty-patients" *ngIf="!loadingPatients && (!doctorPatients || doctorPatients.length === 0)">
            <mat-icon>people_outline</mat-icon>
            <h3>Aucun patient trouvé</h3>
            <p>Vous n'avez pas encore de patients enregistrés.</p>
          </div>

          <div class="patients-table-container" *ngIf="!loadingPatients && doctorPatients && doctorPatients.length > 0">
            <table class="patients-table">
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Email</th>
                  <th>Téléphone</th>
                  
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let patient of paginatedPatients">
                  <td class="patient-photo">
                    <div class="patient-avatar">
                      <img 
                           [src]="getPatientProfileImageUrl(patient.id)" 
                           (error)="handleImageError($event)" 
                           alt="Photo de profil">
                      <div *ngIf="!patient.profilePicturePath" class="avatar-initials">
                        {{ patient.prenom?.charAt(0) }}{{ patient.nom?.charAt(0) }}
                      </div>
                    </div>
                  </td>
                  <td>{{ patient.nom }}</td>
                  <td>{{ patient.prenom }}</td>
                  <td>{{ patient.email }}</td>
                  <td>{{ patient.phoneNumber }}</td>
                  <td>{{ patient.lastAppointment | date:'dd/MM/yyyy' }}</td>
                  <td class="actions-cell">
                    <button mat-icon-button matTooltip="Voir les détails" (click)="viewPatientDetails(patient)">
                      <mat-icon>visibility</mat-icon>
                    </button>
                    
                    <button mat-icon-button matTooltip="Modifier la fiche patient" (click)="openEditFicheDialog(patient)">
                      <mat-icon>edit</mat-icon>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="pagination-container">
              <mat-paginator
                [length]="doctorPatients.length"
                [pageSize]="pageSize"
                [pageSizeOptions]="[5, 10, 20]"
                (page)="onPageChange($event)"
                aria-label="Sélectionner la page">
              </mat-paginator>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile View -->
      <div *ngIf="activeSection === 'profile' && !bannedUserService.isBanned()">
        <app-profile></app-profile>
      </div>

      <div *ngIf="activeSection === 'validate-account' && !bannedUserService.isBanned()">
        <app-validate-account></app-validate-account>
      </div>

      <div *ngIf="activeSection === 'appointments' && !bannedUserService.isBanned()">
        <app-doctor-secretary-view></app-doctor-secretary-view>
      </div>

      <div *ngIf="activeSection === 'calendar' && !bannedUserService.isBanned()">
        <app-appointment-calendar></app-appointment-calendar>
      </div>

      <div *ngIf="activeSection === 'statistics' && !bannedUserService.isBanned()">
        <app-doctor-statistics></app-doctor-statistics>
      </div>

      <!-- Messaging always accessible -->
      <div *ngIf="activeSection === 'messaging'">
        <app-messaging></app-messaging>
      </div>

      <div *ngIf="activeSection === 'secretary-applications' && !bannedUserService.isBanned()">
        <app-secretary-applications></app-secretary-applications>
      </div>

    

      <div *ngIf="activeSection === 'unassigned-secretaries' && !bannedUserService.isBanned()">
        <app-unassigned-secretaries></app-unassigned-secretaries>
      </div>

      <div *ngIf="activeSection === 'assigned-secretaries' && !bannedUserService.isBanned()">
        <app-assigned-secretaries></app-assigned-secretaries>
      </div>
    </div>
  </div>

  <!-- Add mobile menu toggle button at bottom right on small screens -->
  <button *ngIf="isMobile" class="menu-toggle mobile-fab" (click)="toggleMenu()">
    <mat-icon>{{ isMenuOpen ? 'close' : 'menu' }}</mat-icon>
  </button>
</div>

